\RequirePackage{minted}
\RequirePackage{tocbasic}
\RequirePackage{polyglossia}
\setdefaultlanguage[variant=uk]{english}
%\setmainlanguage[variant=uk]{english}
\RequirePackage[english, iso]{isodate}
\RequirePackage{varioref}
\RequirePackage[breaklinks=true,colorlinks]{hyperref}
\RequirePackage{refcount}
\RequirePackage[natbib=true,backend=biber,style=authoryear,isbn=false,%url=false,%
doi=false,url=false,dashed=false,eprint=false,giveninits=true,hyperref=true,%
maxcitenames=1,maxbibnames=99,useprefix,backref,uniquename=init,
labeldate=year,alldates=year,urldate=short]{biblatex} %add backref for draft
\renewbibmacro{in:}{} %from: https://tex.stackexchange.com/a/10686/102519
%from https://tex.stackexchange.com/a/27107/102519
% so name in citations are also link
\DeclareFieldFormat{citehyperref}{%
  \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
  \bibhyperref{#1}}

\DeclareFieldFormat{textcitehyperref}{%
  \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
  \bibhyperref{%
#1%
\ifbool{cbx:parens}
      {\bibcloseparen\global\boolfalse{cbx:parens}}
      {}}}

\savebibmacro{cite}
\savebibmacro{textcite}

\renewbibmacro*{cite}{%
  \printtext[citehyperref]{%
    \restorebibmacro{cite}%
    \usebibmacro{cite}}}

\renewbibmacro*{textcite}{%
  \ifboolexpr{%
    ( not test {\iffieldundef{prenote}} and
      test {\ifnumequal{\value{citecount}}{1}} )
    or
    ( not test {\iffieldundef{postnote}} and
      test {\ifnumequal{\value{citecount}}{\value{citetotal}}} )
  }
    {\DeclareFieldAlias{textcitehyperref}{noformat}}
    {}%
  \printtext[textcitehyperref]{%
    \restorebibmacro{textcite}%
    \usebibmacro{textcite}}}
%%%
%%% follow code to remove the langage entry from the \fullcite
%%% mix of https://tex.stackexchange.com/a/146438/102519
%%% and https://tex.stackexchange.com/a/104502/102519
%\DeclareCiteCommand{\fullcite}
%  {\usebibmacro{prenote}}
%  {\clearlist{language}\usedriver
%     {\DeclareNameAlias{sortname}{default}}
%     {\thefield{entrytype}}}
%  {\multicitedelim}
%  {\usebibmacro{postnote}}

\DeclareCiteCommand{\fullcite}
{\usebibmacro{prenote}}
{\clearlist{language}
\iffieldundef{doi}
    {\iffieldundef{url}{\usedriver
       {\DeclareNameAlias{sortname}{default}}
       {\thefield{entrytype}}}
      {\href{\thefield{url}}{\usedriver
       {\DeclareNameAlias{sortname}{default}}
       {\thefield{entrytype}}}}}
    {\href{http://dx.doi.org/\thefield{doi}}{\usedriver
    {\DeclareNameAlias{sortname}{default}}
    {\thefield{entrytype}}}}}
{\multicitedelim}
{\usebibmacro{postnote}}



%\usepackage[explicit]{titlesec}
\RequirePackage[dottedtoc,eulerchapternumbers]{classicthesis}
%\RequirePackage{arsclassica}
%%%if arsclassica:
%\renewcommand{\sfdefault}{lmss}
%\renewcommand\formatchapter[1]{%
%  \begin{minipage}[b]{0.15\linewidth}
%    \chapterNumber
%  \end{minipage}%
%  \begin{minipage}[b]{0.75\linewidth}
%    \raggedright\spacedallcaps{#1}
%  \end{minipage}
%}
%%%%%%%%%

\RequirePackage[english=british]{csquotes}
%\RequirePackage{epigraph}
%\renewcommand{\epigraphflush}{center}
\RequirePackage{booktabs,dcolumn}
\RequirePackage{microtype}
\RequirePackage{rotating}
\RequirePackage{multirow}
%\usepackage[table,xcdraw]{xcolor}
\RequirePackage{relsize}
\RequirePackage%[onehalfspacing]
{setspace}
%\usepackage[multidot]{grffile}
\RequirePackage{marginnote}
\RequirePackage{float}
\RequirePackage{placeins}
\RequirePackage{fontspec}
\RequirePackage{comment}
\RequirePackage{amsmath}
\RequirePackage{unicode-math}
\RequirePackage{xpatch}
\RequirePackage{xltxtra}
\RequirePackage{xcolor}
\RequirePackage{calc}
\RequirePackage{libertine}
\RequirePackage[font=bf,format=hang,labelfont={bf,normal},textfont=normal,up,margin=5pt,labelformat=default,labelsep=period]{caption}
%format=hang
%\usepackage[font=small,format=plain,labelfont=bf,up,textfont=normal,up,justification=justified,singlelinecheck=false,margin=5pt]{caption}
\RequirePackage{subcaption}
%\usepackage[user,xr]{zref} %for cross reference between files

%\usepackage{ifoddpage}
\RequirePackage{afterpage}
\RequirePackage{verbatim}
\RequirePackage{xspace} %the original author doesn't recommend it
\RequirePackage{pgfplots}
\pgfplotsset{compat=1.14}
\RequirePackage{expdlist}
\RequirePackage{pdflscape}
\RequirePackage{longtable}
\RequirePackage{enumitem}
\RequirePackage{eqlist}
\RequirePackage[ruled,vlined]{algorithm2e}
\RequirePackage{tracklang}
\RequirePackage{mfirstuc}
\RequirePackage{etoolbox}
\RequirePackage{xkeyval}
\RequirePackage{textcase}
\RequirePackage{xfor}
\RequirePackage{datatool-base}
\RequirePackage{amsgen}
\RequirePackage{interval}
\RequirePackage{ragged2e}
\RequirePackage{soul}
%\usepackage{arsclassica}
\RequirePackage[xindy, toc, nopostdot,nolist]{glossaries} %%after hyperref loaded
\RequirePackage[automake,nomain,acronym]{glossaries-extra}
\setglossarystyle{longheader}
%\setabbreviationstyle[acronym]{long-short}
\makeglossaries%
%\loadglsentries{glossary.tex}

\RequirePackage{scrhack} %to avoid some possible reported clashs
\RequirePackage{bookmark}
\RequirePackage{geometry}%% for page layout
\RequirePackage[nameinlink, noabbrev]{cleveref}
\crefname{subsection}{subsection}{subsections}
\Crefname{subsection}{Subsection}{Subsections}
\crefname{subsubsection}{subsubsection}{subsubsections}
\Crefname{subsubsection}{Subsubsection}{Subsubsections}
\crefname{minisec}{segment}{segments}
\crefname{appsec}{appendix}{appendices}
\Crefname{appsec}{Appendix}{Appendices}
\RequirePackage{isotope}
\RequirePackage[mark]{gitinfo2}
%\RequirePackage[inline]{showlabels}
%\renewcommand{\showlabelsetlabel}[1]
%{\begin{turn}{10}\color{red}\showlabelfont #1\end{turn}}

%\setmainfont[Mapping=tex-text, Numbers=OldStyle]{TeX Gyre Pagella}
%\setmainfont[Ligatures={NoRequired,NoCommon,NoContextual}]{Font Name}
%\setsansfont[Mapping=tex-text, Numbers=OldStyle]{Droid Sans}
%\setmonofont{Droid Sans Mono}

%\setmainfont[Ligatures=TeX, Numbers=OldStyle]{GaramondNo8}

%\setmainfont[Ligatures=TeX, Numbers=OldStyle]{TeX Gyre Pagella}
%\setmainfont[Ligatures=NoCommon]{Linux Libertine O}

%\setmainfont[Ligatures=TeX, Numbers=OldStyle]{Helvetica}

\setmainfont[Ligatures=NoCommon,
    FontFace = {sb}{n}{Linux Libertine O Semibold},
    FontFace = {sb}{it}{Linux Libertine O Semibold Italic},
    BoldFont = {Linux Libertine O Bold},
    BoldItalicFont = {Linux Libertine O Bold Italic},
]{Linux Libertine O}


\setsansfont[
    Ligatures=TeX,
    UprightFont={* Light},
    BoldFont={*},
    ItalicFont={* Light Italic},
    BoldItalicFont={* Italic},
    Scale=MatchLowercase
]{Gill Sans}
\setmonofont[Scale=MatchLowercase]{WenQuanYi Zen Hei Mono}
\setmathfont[
    Extension=.otf,
    BoldFont=*bold,
]{xits-math}

\setmathfont[bold-style=TeX]{Latin Modern Math}

\DeclareOldFontCommand{\sbseries}{\fontseries{sb}\selectfont}{\mathbf}
\DeclareTextFontCommand{\textsb}{\sbseries}



%%%% Libertinus instead?
%\setmainfont[Ligatures=NoCommon]{Libertinus Serif}
%\setsansfont[Ligatures=NoCommon]{Libertinus Sans}
%\setmonofont{Libertinus Mono}
%\setmathfont{Libertinus Math}
%%%%%%


%%%% Check with classicthesis manual to redefine the chapter and sections formats
%\titleformat{\chapter}[display]%
%{\relax}{\mbox{}\oldmarginpar{\vspace*{-3\baselineskip}\color{halfgray}\chapterNumber\thechapter}}{0pt}%
%{\raggedright\spacedallcaps}[\Huge\vspace*{.8\baselineskip}\titlerule]
%%sections
%\titleformat{\section}
%{\relax}{\textbf{\MakeTextLowercase{\thesection}}}{1em}{\spacedlowsmallcaps}
%%subsections
%\titleformat{\subsection}{\relax}{\textsc{\MakeTextLowercase{\thesubsection}}}{1em}{\normalsize}
%%subsubsections
%\titleformat{\subsubsection}{\relax}{\textsc{\MakeTextLowercase{\thesubsubsection}}}{0.5em}{\normalsize}
%% need to take care of the numbering of the captions if used.

\setkomafont{title}{\rmfamily\Huge}
\setkomafont{subject}{\normalfont\normalcolor}
\isodash{\ensuremath{\cdot}}% Replacement for `‧` = U+‧2027 HYPHENATION POINT
\setkomafont{minisec}{\libertineSB\small}


\definecolor{cambridgeblue}{RGB}{163, 193, 173}
\definecolor{cambridgebluedark}{RGB}{17, 94, 103}
%\definecolor{ebidark}{RGB}{0, 124, 130}
%\definecolor{ebilight}{RGB}{RGB}{45, 124, 130}

%\defaultfontfeatures{Ligatures=TeX,Numbers=OldStyle}

\addbibresource{Bibliography.bib}
\addbibresource[label=ownpubs]{Publications.bib}


\setstretch{1.1}
\graphicspath{{gfx/}} %as instructed in classicthesis



%\graphicspath{{gfxRasterOnly/}} %as instructed in classicthesis
% For debugging: showframe=true to see the layout frames
\geometry{bottom=65mm,showframe=false,margin=35mm,marginparsep=3mm,marginparwidth=20mm}
%have a look at innermargin

\pagestyle{scrheadings}

\hypersetup{%
    pdftitle={M. Barzine - PhD thesis, University of Cambridge (2018)},
    pdfauthor={Mitra Barzine},
    linkcolor=darkgray,
    citecolor=teal
}

%%%%%%%
%%% customisation stollen from Manuel Kuehner template
%%some calculations
%% calc package is needed which is loaded here: 01_Preamble/CommonPackages.tex
%% If you want to understand the calculations visit:
%% http://en.wikibooks.org/wiki/LaTeX/Page_Layout
\newlength{\myLenghthFootAbstand}
\setlength{\myLenghthFootAbstand}{\paperheight-1in-\topmargin- \headheight-\headsep-\textheight-\footskip}
\newlength{\myLenghthTemp}
\setlength{\myLenghthTemp}{\myLenghthFootAbstand+\baselineskip}

\clearscrheadfoot%
% Header
\ohead{%
    \headmark%
    }
% Left (even page numbers) footer
\lefoot%
[% scrplain style (begin)
    \setlength{\unitlength}{\myLenghthFootAbstand}%
    \begin{picture}(0,0)%
        \put(0,-1)%
        {%
            \makebox(0,0)[lb]%
            {%
                \rule{0.4pt}{\myLenghthTemp}%
            }%
        }%
    \end{picture}
    \llap{\pagemark~~~~~}
]% scrplain style (end)
%
{% scrheadings style (begin)
    \setlength{\unitlength}{\myLenghthFootAbstand}%
    \begin{picture}(0,0)%
        \put(0,-1)%
        {%
            \makebox(0,0)[lb]%
            {%
                \rule{0.4pt}{\myLenghthTemp}%
            }%
        }%
    \end{picture}
    \llap{\pagemark~~~~~}%
    }% scrheadings style (end)

%% Right (odd page numbers) footer
\rofoot%
[% scrplain style (begin)
    \rlap{~~~~~\pagemark}%%
    \setlength{\unitlength}{\myLenghthFootAbstand}%
    \begin{picture}(0,0)%
        \put(0,-1)%
        {%
            \makebox(0,0)[lb]%
            {%
                \rule{0.4pt}{\myLenghthTemp}%
            }%
        }%
    \end{picture}%
    ]% scrplain style (end)
    %
{% scrplain style (begin)
    \rlap{~~~~~\pagemark}%%
    \setlength{\unitlength}{\myLenghthFootAbstand}%
    \begin{picture}(0,0)%
        \put(0,-1)%
        {%
            \makebox(0,0)[lb]%
            {%
                \rule{0.4pt}{\myLenghthTemp}%
            }%
        }%
    \end{picture}%
    }% scrplain style (end)





\setlength{\headheight}{1.1\baselineskip}
%%%%%%%



% %%% More layout definitions
%    \definecolor{primary}{HTML}{429EB6}
%    \definecolor{secondary}{HTML}{DE8950}
%    \definecolor{tertiary}{HTML}{4DB966}
%    \definecolor{quarternary}{HTML}{F3B5FB}
%    \definecolor{quinary}{HTML}{E7BE05}
%    \newcommand*\primaryname{blue}
%    \newcommand*\secondaryname{orange}
%    \newcommand*\tertiaryname{green}
%    \newcommand*\quarternaryname{purple}
%    \newcommand*\quinaryname{yellow}
%
%    \colorlet{thesis@toccolor}{black}
%    \colorlet{thesis@linkcolor}{black!70}
%
%    \definecolor{codenormal}{HTML}{404040}
%    \AtBeginEnvironment{minted}{\color{codenormal}}
%    \usemintedstyle{klmrthesis}

%   \hypersetup{%
%        hypertexnames=false,
%        linktoc=all,
%        colorlinks,
%        citecolor=thesis@linkcolor,
%        linkcolor=thesis@linkcolor,
%        filecolor=thesis@linkcolor,
%        urlcolor=thesis@linkcolor
%    }


%%%%%%%
%\newcounter{dataset}[chapter]
%\newenvironment{dataset}[1][]{\refstepcounter{dataset}\par\medskip
%   \textbf{Dataset~\thedataset. #1} \rmfamily}{\medskip}

%%%%% new custom list (of datasets)
%\DeclareNewTOC[%
%    type=dataset,%
%    types=datasets,% used in the \listof.. command
%    chapter,% define a chapter environment
%    name=Dataset,%
%    listname={List of datasets}%
%    ]{lod}

%%%have a look at http://tex.stackexchange.com/questions/198932/list-of-newcounter/198957#198957
%%%% and at http://tex.stackexchange.com/questions/6478/new-figure-environment/96493#96493


%%%% custom macros
\newcommand*\captitle[1]{\textbf{#1}}
\setkomafont{caption}{\bfseries\sffamily}

%if use of classicthesis
\newcommand*\todo[1]{%
    \graffito{\textcolor{red}{TO\ DO:~#1}}}

%if no use of classicthesis but \usepackage{scrpage2} instead
%\newcommand*\todo[1]{%
%    \comment{TO\ DO:#1}}

\newcommand{\fixme}[1]{{\let\marginpar\oldmarginpar\todo{#1}}}

\newcommand*\TK[1]{
    \textcolor{blue}{[TK:\ #1]}}


\newcommand*\del[1]{\large\textcolor{red}{#1}}


\newcommand*\Rough[1]{
    Speak about:
    \textsl{\textcolor{gray}{#1}}}

\newcommand*\rough[1]{\textsl{\textcolor{gray}{#1}}}

%%%% shortcuts
\newcommand*\myPlace{Cambridge (UK)}
\newcommand*\myDate{\today}
\newcommand*\myName{Mitra Parissa Barzine}

\input{semanticMacro.tex}

\newcommand*\subcap[1]{\small{#1}}


%%% TOC customisation
\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{7}


%\titleformat*{\section}{\LARGE\bfseries}
%\titleformat*{\subsection}{\Large\bfseries}
%\titleformat*{\subsubsection}{\large\bfseries}
%\titleformat*{\paragraph}{\large\bfseries}
%\titleformat*{\subparagraph}{\large\bfseries}



%%%%%% from arsclassica code %%%%%

%% pages headers
%\renewcommand{\sectionmark}[1]{\markright{\textsc%
%{\MakeTextLowercase{\thesection}} \spacedlowsmallcaps{#1}}}
%\lehead{\mbox{\llap{\small\kern1em\color{halfgray}%
%}%
%\color{halfgray}\hspace{0.5em}\headmark\hfil}}
%\rohead{\mbox{\hfil{\color{halfgray}%
%\headmark\hspace{0.5em}}%
%\rlap{\small{\color{halfgray}}\kern1em}}}
%% Bullet list
\renewcommand\labelitemi{\color{halfgray}$\bullet$}

%title format

\newcommand\formatchapter[1]{%
\vbox to \ht\strutbox{
\setbox0=\hbox{\chapterNumber\thechapter\hspace{10pt}\vline\
}
\advance\hsize-\wd0 \advance\hsize-10pt\raggedright
\spacedallcaps{#1}\vss}}
\titleformat{\chapter}[block]
{\normalfont\Large}
{\textcolor{halfgray}{\chapterNumber\thechapter}
\hspace{10pt}\vline\ }{10pt}
{\formatchapter}



\renewcommand\formatchapter[1]{%
  \begin{minipage}[b]{0.15\linewidth}
    \chapterNumber
  \end{minipage}%
  \begin{minipage}[b]{0.75\linewidth}
    \raggedright\spacedallcaps{#1}
  \end{minipage}
}


%%%% ugly hack needed to fix the headers in the \chapter*{}
%helped found here:https://tex.stackexchange.com/q/226327/102519 and a bit more
% from Konrad Rudolph
\newcommand{\replaceText}{\spacedlowsmallcaps{Introduction%
}}

%Answer to the Ultimate Question of Life, the Universe, and Everything%
%\lehead{\mbox{\llap{\small\kern2em}\ifnum\value{page}=42\replaceText\else\headmark\fi\hfil}}
%\rohead{\mbox{\hfil{\ifnum\value{page}=42\replaceText\else\headmark\fi}\rlap{\small\kern2em}}}

\lehead{\mbox{\llap{\small\kern2em\color{halfgray}}\ifnum\value{page}=3\replaceText\else\ifnum\value{page}=2\replaceText\else\headmark\fi\fi\hfil}}
\rohead{\mbox{\hfil{\ifnum\value{page}=3\replaceText\else\ifnum\value{page}=2\replaceText\else\headmark\fi\fi}\rlap{\small\kern2em\color{halfgray}}}}


